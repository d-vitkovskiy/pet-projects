# Предсказание совершения пользователем целевого действия на сайте "СберАвтоподписка"

![tmp2943g1tv](https://user-images.githubusercontent.com/103372805/202800560-5b020e5d-5e22-4ea9-a05e-e40ca3fc2aa0.svg)

## 1. Описание
**«СберАвтоподписка»** — это сервис долгосрочной аренды автомобилей для физлиц.
На сайте сервиса пользователь совершает целевые действия. Например, нажимает кнопки типа «Оставить заявку», «Заказать звонок». Или нецелевые действия, например, 
просмотр карточек авто или «блуждания» по основной странице и страницам. Таким образом, по поведению пользователя нужно предсказать, совершит ли он 
целевое действие или нет. В качестве исходных данных нам предоставляются два датасета. В одном содержится информация по визитам на сайт, а в другом - информациях о 
событиях в рамках одного визита. Данные взяты из GoogleAnalytics по сайту "СберАвтоподписка".

## 2. Что нужно сделать
1. Необходимо предсказать совершение целевого действия пользователя (задача бинарной классификации)
2. Достичь точности метрики _ROC_AUC_ не хуже 0.65 на тренировочном датасете и не хуже 0.55 на тестовом (тестовый датасет изначально закрыт)
3. Написать сервис, который будет брать на вход все атрибуты типа visit_\*, utm_\*, device_\*, geo_\*, и отдавать на выход 0/1 (1 — если пользователь совершит любое целевое действие).

## 3. Краткая информация о данных
Описание атрибутов датасета _GA Sessions_
- **session_id** — ID визита;
- **client_id** — ID посетителя;
- **visit_date** — дата визита;
- **visit_time** — время визита;
- **visit_number** — порядковый номер визита клиента;
- **utm_source** — канал привлечения;
- **utm_medium** — тип привлечения;
- **utm_campaign** — рекламная кампания;
- **utm_keyword** — ключевое слово;
- **device_category** — тип устройства;
- **device_os** — ОС устройства;
- **device_brand** — марка устройства;
- **device_model** — модель устройства;
- **device_screen_resolution** — разрешение экрана;
- **device_browser** — браузер;
- **geo_country** — страна;
- **geo_city** — город.

Описание атрибутов датасета _GA Hits_
- **session_id** — ID визита;
- **hit_date** — дата события;
- **hit_time** — время события;
- **hit_number** — порядковый номер события в рамках сессии;
- **hit_type** — тип события;
- **hit_referer** — источник события;
- **hit_page_path** — страница события;
- **event_category** — тип действия;
- **event_action** — действие;
- **event_label** — тег действия;
- **event_value** — значение результата действия.

**ПРИМЕЧАНИЕ:** целевые значения в явном виде отсутствуют. Их нужно будет извлечь из датасета _GA Hits_ по признаку **event_action** (см. Глоссарий)

## 4. Содержание работы
**_Разведочный анализ_**

В ходе исследования данных были выявлены факторы, которые накладывают серьёзные ограничения на точностные характеристики нашей модели. Во-первых: это сильный дисбаланс классов - целевые значения составляли всего лишь 3 % от общего количества. Во-вторых: большое количество уникальных значений для категориальных признаков (до 4 тыс.). В-третьих: малое число числовых признаков - только номер визита и дата со временем. Как следствие, отсутствие возможности изучения влияния большей части признаков друг на друга с целью установления зависимостей. 

Визуализация признаков показала, что в основном сохраняется пропорциональность в те самые 3 % между целевыми и нецелевыми действиями. Но были выявлены и некоторые особенности (в ноутбуке более подробное описание).

**_Моделирование_**

Сравнение моделей проводилось с использованием библиотеки _scikit-learn_ (см. Замечания). Использовались линейные модели (_SGDClassifier_, _LogisticRegression_), метод опорных векторов (_SVC_, _LinearSVC_), модели на основе деревьев (_DecisionTreeClassifier_, _ExtraTreeClassifier_), ансамблевые методы (_RandomForestClassifier_, _VotingClassifier_), а также бустинги (_XGBClassifier_, _LGBMClassifier_). Для тюнинга гиперпараметров использовался _HyperOpt_. Лучший результат показали алгоритмы на основе бустинга. Из остальных методов лучшими оказались логистическая регрессия и классификатор с голосованием. В работе не использовался _CatBoostClassifier_, но в дальнейшем планирую его тоже протестировать.

## 5. Результаты работы
1. Удалось достигнуть необходимого значения метрики _ROC_AUC_ = 0.65 на тренировочной выборке с _XGBClassifier_. На закрытой тестовой выборке точность составила 0.57, что тоже является приемлемым результатом. Остальным моделям достигнуть аналогичного результата не удалось.
2. Создан пайплайн подготовки "сырых" данных на основе _XGBClassifier_, а также скрипт, реализующий GET и POST запросы, используя FastAPI. 

## 6. Запуск программы
Для запуска программы необходимо активировать нужное окружение. Затем в данное окружение необходимо установить [FastAPI](https://github.com/tiangolo/fastapi), если ещё не установлено.
Сделать это можно следующим образом:

используя pip
```
$ pip install fastapi
```

или conda
```
$ conda install -c conda-forge fastapi
```

Может потребоваться установка [Uvicorn](https://www.uvicorn.org/), если ещё не установлено.
Сделать это можно следующим образом:

используя pip
```
$ pip install uvicorn
```

или conda
```
$ conda install -c conda-forge uvicorn
```

Затем в терминале перейти в папку, в которой находится файл main.py (см. структуру ниже) и ввести следующую команду
```
$ uvicorn main:app --reload
```
![image](https://user-images.githubusercontent.com/103372805/201987248-9914026c-d06e-46d0-80fe-37492458d2a3.png)

Для проверки работы сервиса можно открыть любое приложение для работы с API, например Postman. Чтобы убедиться, что программа работает, можно создать
GET-запрос

![image](https://user-images.githubusercontent.com/103372805/202774666-94f337cc-e953-4de3-944f-cfd2be04ce9b.png)

Если получили ответ OK, значит всё работает. Аналогичным образом можно проверить версию программы, для этого нужно создать соответствующий GET-запрос

![image](https://user-images.githubusercontent.com/103372805/202774906-60530976-2f83-4912-93c0-b2b3be01291f.png)

Чтобы непосредственно проверить работу, нужно создать POST-запрос, перейти на вкладку **Body**, выбрать **raw**, а затем **JSON**. 
После этого передать данные в формате json

![image](https://user-images.githubusercontent.com/103372805/202780031-4122a94e-3901-45f1-8493-7c5cd25dbf81.png)

Если получен ответ, то всё работает

## 6. Замечания

В работе использовался [Intel(R) Extension for Scikit-learn](https://github.com/intel/scikit-learn-intelex) для ускорения вычислений _LogisticRegression_, _SVC_, _RandomForestClassifier_. Для работы с данной библиотекой требуется версия **scikit-learn** не выше **1.0.2**.

## 7. Глоссарий

**Целевое действие** — события типа «Оставить заявку» и «Заказать звонок» (ga_hits.event_action in \['sub_car_claim_click', 'sub_car_claim_submit_click', 'sub_open_dialog_click', 'sub_custom_question_submit_click', 'sub_call_number_click', 'sub_callback_submit_click', 'sub_submit_success', 'sub_car_request_submit_click'\]).

**CR (Conversion Rate)** — показатель конверсии из визита (уникальный session_id) в любое целевое действие в рамках одного визита (в случае наличия >1 целевого действия — считать все как одно).

**Органический трафик** — все визиты с ga_sessions.utm_medium in ('organic', 'referral', '(none)').

**Платный трафик**  — весь неорганический трафик.

**Реклама в социальных сетях** — все визиты с ga_sessions.utm_source in ('QxAxdyPLuQMEcrdZWdWb', 'MvfHsxITijuriZxsqZqt', 'ISrKoXQCxqqYvAZICvjs', 'IZEXUFLARCUMynmHNBGo', 'PlbkrSYoHuZBWfYjYnfw', 'gVRrcxiDQubJiljoTbGm').


